"use strict";exports.id=5180,exports.ids=[5180],exports.modules={9303:(t,e,i)=>{t.exports=i(517)},7536:(t,e,i)=>{i.d(e,{Z:()=>n});var o=i(629),s=i(5315),r=i(2048),a=i(7702);class n extends a.EventEmitter{constructor(t="Jarvis",e={}){super(),this.context=t,this.config={level:process.env.LOG_LEVEL||"info",format:"json",output:["console","file"],logDir:"./logs",maxFileSize:10485760,maxFiles:5,enableColors:!0,enableTimestamp:!0,enableContext:!0,enableMetadata:!0,remoteEndpoint:null,...e},this.levels={error:{priority:0,color:"\x1b[31m",emoji:"❌"},warn:{priority:1,color:"\x1b[33m",emoji:"⚠️"},info:{priority:2,color:"\x1b[36m",emoji:"ℹ️"},debug:{priority:3,color:"\x1b[35m",emoji:"\uD83D\uDD0D"},trace:{priority:4,color:"\x1b[37m",emoji:"\uD83D\uDD2C"}},this.state={isInitialized:!1,fileStream:null,buffer:[],stats:{totalLogs:0,errorCount:0,warnCount:0,lastError:null,startTime:Date.now()}},this.initialize()}async initialize(){try{await this.ensureLogDirectory(),this.config.output.includes("file")&&await this.setupFileLogging(),this.config.remoteEndpoint&&await this.setupRemoteLogging(),this.state.isInitialized=!0,this.info("Logger initialis\xe9",{context:this.context,config:this.config})}catch(t){console.error("❌ Erreur initialisation logger:",t)}}error(t,e={},i=null){this.log("error",t,{...e,error:i?.stack||i}),this.state.stats.errorCount++,this.state.stats.lastError={message:t,timestamp:Date.now(),error:i}}warn(t,e={}){this.log("warn",t,e),this.state.stats.warnCount++}info(t,e={}){this.log("info",t,e)}debug(t,e={}){this.log("debug",t,e)}trace(t,e={}){this.log("trace",t,e)}log(t,e,i={}){if(!this.shouldLog(t))return;let o=this.createLogEntry(t,e,i);this.state.stats.totalLogs++,this.config.output.includes("console")&&this.logToConsole(o),this.config.output.includes("file")&&this.state.fileStream&&this.logToFile(o),this.config.remoteEndpoint&&this.logToRemote(o),this.emit("log",o),this.emit(t,o)}shouldLog(t){let e=this.levels[this.config.level]?.priority??2;return(this.levels[t]?.priority??2)<=e}createLogEntry(t,e,i={}){let o=new Date().toISOString();this.levels[t]||this.levels.info;let s={timestamp:o,level:t.toUpperCase(),context:this.context,message:e,pid:process.pid,hostname:process.env.HOSTNAME||"localhost"};return this.config.enableMetadata&&Object.keys(i).length>0&&(s.metadata=i),("error"===t||"warn"===t)&&(s.system={memory:process.memoryUsage(),uptime:process.uptime(),version:process.version}),s}logToConsole(t){let e=this.levels[t.level.toLowerCase()],i=this.config.enableColors?e.color:"",o=this.config.enableColors?"\x1b[0m":"",s=e.emoji,r="";"json"===this.config.format?r=JSON.stringify(t):"structured"===this.config.format?r=this.formatStructured(t):(r=`${s} [${t.timestamp}] ${t.level} [${t.context}]: ${t.message}`,t.metadata&&Object.keys(t.metadata).length>0&&(r+=` ${JSON.stringify(t.metadata)}`)),console.log(`${i}${r}${o}`)}logToFile(t){if(!this.state.fileStream)return;let e=JSON.stringify(t)+"\n";this.state.fileStream.write(e),this.checkFileRotation()}async logToRemote(t){try{this.state.buffer.push(t),this.state.buffer.length>=10&&await this.flushRemoteBuffer()}catch(t){console.error("Erreur logging distant:",t.message)}}formatStructured(t){let e=[`[${t.timestamp}]`,`${t.level.padEnd(5)}`,`[${t.context}]`,t.message].join(" ");if(t.metadata){let i=Object.entries(t.metadata).map(([t,e])=>`${t}=${JSON.stringify(e)}`).join(" ");i&&(e+=` | ${i}`)}return e}async setupFileLogging(){let t=s.join(this.config.logDir,`${this.context.toLowerCase()}.log`);this.state.fileStream=(0,r.createWriteStream)(t,{flags:"a"}),this.state.fileStream.on("error",t=>{console.error("❌ Erreur stream de log:",t)})}async checkFileRotation(){try{let t=s.join(this.config.logDir,`${this.context.toLowerCase()}.log`);(await o.stat(t)).size>this.config.maxFileSize&&await this.rotateLogFile()}catch(t){}}async rotateLogFile(){try{let t=s.join(this.config.logDir,`${this.context.toLowerCase()}.log`);this.state.fileStream&&this.state.fileStream.end();for(let e=this.config.maxFiles-1;e>0;e--){let i=`${t}.${e}`,s=`${t}.${e+1}`;try{await o.rename(i,s)}catch(t){}}await o.rename(t,`${t}.1`),await this.setupFileLogging(),this.info("Rotation des logs effectu\xe9e",{maxSize:this.config.maxFileSize,maxFiles:this.config.maxFiles})}catch(t){console.error("❌ Erreur rotation logs:",t)}}async setupRemoteLogging(){setInterval(()=>{this.state.buffer.length>0&&this.flushRemoteBuffer()},3e4)}async flushRemoteBuffer(){if(0===this.state.buffer.length)return;let t=[...this.state.buffer];this.state.buffer=[];try{let e=await fetch(this.config.remoteEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.LOG_TOKEN||""}`},body:JSON.stringify({logs:t})});if(!e.ok)throw Error(`HTTP ${e.status}: ${e.statusText}`)}catch(e){this.state.buffer.unshift(...t),console.error("❌ Erreur envoi logs distants:",e.message)}}async ensureLogDirectory(){try{await o.mkdir(this.config.logDir,{recursive:!0})}catch(t){console.error("❌ Erreur cr\xe9ation r\xe9pertoire logs:",t)}}setLevel(t){this.levels[t]?(this.config.level=t,this.info(`Niveau de log chang\xe9: ${t}`)):this.warn(`Niveau de log invalide: ${t}`)}addOutput(t){this.config.output.includes(t)||(this.config.output.push(t),this.info(`Output ajout\xe9: ${t}`))}removeOutput(t){let e=this.config.output.indexOf(t);e>-1&&(this.config.output.splice(e,1),this.info(`Output supprim\xe9: ${t}`))}getStats(){return{...this.state.stats,uptime:Date.now()-this.state.stats.startTime,level:this.config.level,outputs:this.config.output,bufferSize:this.state.buffer.length}}async cleanup(t=6048e5){try{let e=await o.readdir(this.config.logDir),i=Date.now();for(let r of e){let e=s.join(this.config.logDir,r),a=await o.stat(e);i-a.mtime.getTime()>t&&(await o.unlink(e),this.info(`Fichier de log supprim\xe9: ${r}`,{age:i-a.mtime.getTime()}))}}catch(t){this.error("Erreur nettoyage logs",{},t)}}async search(t,e={}){let{level:i=null,startDate:r=null,endDate:a=null,limit:n=100}=e;try{let e=s.join(this.config.logDir,`${this.context.toLowerCase()}.log`),l=(await o.readFile(e,"utf8")).split("\n").filter(t=>t.trim()),c=[];for(let e of l)try{let o=JSON.parse(e);if(i&&o.level.toLowerCase()!==i.toLowerCase())continue;let s=new Date(o.timestamp);if(r&&s<r||a&&s>a)continue;if(JSON.stringify(o).toLowerCase().includes(t.toLowerCase())&&c.push(o),c.length>=n)break}catch(t){}return c}catch(t){return this.error("Erreur recherche logs",{},t),[]}}async export(t="json",e={}){let{startDate:i=null,endDate:o=null,level:s=null}=e;try{let e=await this.search("",{startDate:i,endDate:o,level:s,limit:1e4});switch(t){case"json":return JSON.stringify(e,null,2);case"csv":return this.exportToCSV(e);case"txt":return e.map(t=>`[${t.timestamp}] ${t.level} [${t.context}]: ${t.message}`).join("\n");default:throw Error(`Format d'export non support\xe9: ${t}`)}}catch(t){throw this.error("Erreur export logs",{},t),t}}exportToCSV(t){let e=["timestamp,level,context,message,metadata"];for(let i of t){let t=[i.timestamp,i.level,i.context,`"${i.message.replace(/"/g,'""')}"`,`"${JSON.stringify(i.metadata||{}).replace(/"/g,'""')}"`];e.push(t.join(","))}return e.join("\n")}async close(){try{this.state.buffer.length>0&&await this.flushRemoteBuffer(),this.state.fileStream&&this.state.fileStream.end(),this.info("Logger ferm\xe9 proprement")}catch(t){console.error("❌ Erreur fermeture logger:",t)}}}},3442:(t,e,i)=>{var o=i(1282),s=i(1764);i(629),i(5315),i(4770),(0,s.promisify)(o.exec)}};